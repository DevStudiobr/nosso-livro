<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nossa Biblioteca</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module">
        // Importando os módulos do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDHkscCAj8pSyeN5KPXUn072_5XeSFF04M",
            authDomain: "fire-news-f1be1.firebaseapp.com",
            databaseURL: "https://fire-news-f1be1-default-rtdb.firebaseio.com",
            projectId: "fire-news-f1be1",
            storageBucket: "fire-news-f1be1.appspot.com",
            messagingSenderId: "368411474818",
            appId: "1:368411474818:web:567947238fa8f2da5fad9b",
        };

        // Inicializando Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);

        // Função para carregar livros do Firebase
        function loadBooks() {
            const bookList = document.getElementById('bookList');
            const bookCount = document.getElementById('bookCount');
            bookList.innerHTML = ''; // Limpa a lista antes de carregar

            // Obtendo os livros do Firebase
            const booksRef = ref(database, 'books/');
            onValue(booksRef, (snapshot) => {
                const booksArray = [];
                snapshot.forEach((childSnapshot) => {
                    const bookData = childSnapshot.val();
                    booksArray.push({ key: childSnapshot.key, ...bookData });
                });

                // Atualiza a contagem de livros
                bookCount.textContent = `${booksArray.length} livros`; // Atualiza a contagem

                // Preenche a lista com os livros
                booksArray.forEach((book) => {
                    const li = document.createElement('li');
                    li.textContent = book.title || "Título não disponível"; // Verifica se o título está disponível

                    // Link para download do livro
                    const link = document.createElement('a');
                    link.href = book.url;
                    link.textContent = ' (Baixar Livro)';
                    link.target = '_blank'; // Abre em nova aba
                    link.download = book.title; // Sugere o nome do arquivo para download
                    li.appendChild(link);

                    bookList.appendChild(li);
                });
            });
        }

        // Função para fazer upload de livros
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('fileInput');

            document.getElementById('uploadButton').addEventListener('click', () => {
                const files = fileInput.files;  // Obtendo todos os arquivos selecionados

                if (files.length > 0) {
                    // Itera sobre os arquivos selecionados
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const fileName = file.name.replace('.pdf', ''); // Retira a extensão .pdf
                        const fileStorageRef = storageRef(storage, `books/${file.name}`);

                        // Fazendo o upload de cada arquivo
                        uploadBytes(fileStorageRef, file).then(() => {
                            // Obtendo a URL do livro após o upload
                            getDownloadURL(fileStorageRef).then((url) => {
                                // Adicionando dados do livro ao Firebase
                                const newBookRef = push(ref(database, 'books/'));
                                set(newBookRef, {
                                    title: fileName,
                                    url: url,
                                }).then(() => {
                                    // Recarregar lista de livros após o upload
                                    if (i === files.length - 1) {  // Verifica se é o último arquivo
                                        fileInput.value = '';  // Limpa o input de arquivos
                                        loadBooks(); // Recarregar a lista de livros após todos os uploads
                                    }
                                });
                            });
                        });
                    }
                } else {
                    alert('Por favor, selecione pelo menos um arquivo.');
                }
            });

            // Função de pesquisa
            document.getElementById('search').addEventListener('input', (event) => {
                const searchQuery = event.target.value.toLowerCase();  // Obtém o valor digitado e converte para minúsculas
                const bookList = document.getElementById('bookList');
                const items = bookList.getElementsByTagName('li');  // Todos os <li> dos livros

                // Itera sobre todos os <li> na lista
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];  // Pega cada <li>
                    const title = item.textContent.toLowerCase();  // Texto do título do livro
                    if (title.includes(searchQuery)) {
                        item.style.display = '';  // Mostra o item se combinar com a pesquisa
                    } else {
                        item.style.display = 'none';  // Esconde o item se não combinar
                    }
                }
            });

            loadBooks(); // Carregar livros ao iniciar
        });
    </script>
</head>
<body>
    <header>
        <h1>Nossa Biblioteca</h1>
        <p>Compartilhe e baixe livros gratuitamente!</p>
        <div id="bookCount">0 livros</div> <!-- Contador de livros disponíveis -->
    </header>

    <main>
        <section id="upload-section">
            <h2>Adicionar Livros</h2>
            <!-- Agora aceita múltiplos arquivos -->
            <input type="file" id="fileInput" accept=".pdf" multiple required>
            <button id="uploadButton">Adicionar Livros</button>
        </section>

        <section id="search-section">
            <h2>Pesquisar Livros</h2>
            <input type="text" id="search" placeholder="Pesquise pelo título...">
        </section>

        <section id="books-section">
            <h2>Livros Disponíveis</h2>
            <ul id="bookList"></ul>
        </section>
    </main>
</body>
</html>
