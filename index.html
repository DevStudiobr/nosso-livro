<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nossa Biblioteca</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDHkscCAj8pSyeN5KPXUn072_5XeSFF04M",
            authDomain: "fire-news-f1be1.firebaseapp.com",
            databaseURL: "https://fire-news-f1be1-default-rtdb.firebaseio.com",
            projectId: "fire-news-f1be1",
            storageBucket: "fire-news-f1be1.appspot.com",
            messagingSenderId: "368411474818",
            appId: "1:368411474818:web:567947238fa8f2da5fad9b",
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const storage = getStorage(app);

        function loadBooks() {
            const bookList = document.getElementById('bookList');
            const bookCount = document.getElementById('bookCount');
            const categoryFilter = document.getElementById('categoryFilter');
            bookList.innerHTML = ''; // Limpa a lista antes de carregar
            const booksRef = ref(database, 'books/');
            onValue(booksRef, (snapshot) => {
                const booksArray = [];
                snapshot.forEach((childSnapshot) => {
                    const bookData = childSnapshot.val();
                    booksArray.push({ key: childSnapshot.key, ...bookData });
                });

                // Ordena os livros em ordem alfabética pelo título
                booksArray.sort((a, b) => a.title.localeCompare(b.title));

                bookCount.textContent = `${booksArray.length} livros`;
                booksArray.forEach((book) => {
                    const li = document.createElement('li');
                    li.textContent = book.title || "Título não disponível";

                    const link = document.createElement('a');
                    link.href = book.url;
                    link.textContent = ' (Baixar Livro)';
                    link.target = '_blank';
                    link.download = book.title;
                    li.appendChild(link);

                    // Adiciona categoria ao li
                    if (book.category) {
                        const category = document.createElement('span');
                        category.textContent = ` [${book.category}]`;
                        li.appendChild(category);
                    }

                    bookList.appendChild(li);
                });
                updateSearch(booksArray);
                updateCategoryFilter(booksArray); // Atualiza o filtro de categorias
            });
        }

        function updateCategoryFilter(booksArray) {
            const categoryFilter = document.getElementById('categoryFilter');
            const categories = new Set(booksArray.map(book => book.category).filter(Boolean));
            categoryFilter.innerHTML = '<option value="">Todas as categorias</option>'; // Reinicia as opções

            categories.forEach((category) => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categoryFilter.appendChild(option);
            });

            categoryFilter.addEventListener('change', () => {
                const selectedCategory = categoryFilter.value;
                const bookList = document.getElementById('bookList');
                const items = bookList.getElementsByTagName('li');
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    const category = item.lastChild ? item.lastChild.textContent : '';
                    if (selectedCategory === '' || category.includes(selectedCategory)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('fileInput');
            const categoryInput = document.getElementById('categoryInput');
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressContainer');
            const statusMessage = document.getElementById('statusMessage');
            document.getElementById('uploadButton').addEventListener('click', () => {
                const files = fileInput.files;
                if (files.length > 0) {
                    progressContainer.style.display = 'block';  // Exibe a barra de progresso
                    progressBar.value = 0;  // Reseta a barra de progresso
                    statusMessage.textContent = '';  // Limpa mensagens anteriores
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const fileName = file.name.replace('.pdf', '');
                        const fileStorageRef = storageRef(storage, `books/${file.name}`);
                        const uploadTask = uploadBytesResumable(fileStorageRef, file);
                        uploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                progressBar.value = progress;
                            },
                            (error) => {
                                statusMessage.textContent = 'Erro ao fazer upload: ' + error.message;
                                statusMessage.style.color = 'red';
                                progressContainer.style.display = 'none'; // Esconde a barra de progresso em caso de erro
                            },
                            () => {
                                getDownloadURL(uploadTask.snapshot.ref).then((url) => {
                                    const newBookRef = push(ref(database, 'books/'));
                                    set(newBookRef, {
                                        title: fileName,
                                        url: url,
                                        category: categoryInput.value, // Adiciona a categoria ao livro
                                    }).then(() => {
                                        if (i === files.length - 1) {
                                            fileInput.value = '';
                                            categoryInput.value = ''; // Limpa o campo de categoria após o upload
                                            progressContainer.style.display = 'none';  // Esconde a barra de progresso após o upload
                                            statusMessage.textContent = 'Upload concluído com sucesso!';
                                            statusMessage.style.color = 'green';
                                            loadBooks();
                                        }
                                    });
                                });
                            }
                        );
                    }
                } else {
                    alert('Por favor, selecione pelo menos um arquivo.');
                }
            });

            document.getElementById('search').addEventListener('input', (event) => {
                const searchQuery = event.target.value.toLowerCase();  // Obtém o valor digitado e converte para minúsculas
                const bookList = document.getElementById('bookList');
                const items = bookList.getElementsByTagName('li');  // Todos os <li> dos livros
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    const title = item.firstChild.textContent.toLowerCase();  // Texto do título do livro
                    if (title.includes(searchQuery)) {
                        item.style.display = '';  // Mostra o item se combinar com a pesquisa
                    } else {
                        item.style.display = 'none';  // Esconde o item se não combinar
                    }
                }
            });

            loadBooks();
        });

        function updateSearch(booksArray) {
            const searchInput = document.getElementById('search');
            searchInput.addEventListener('input', () => {
                const searchQuery = searchInput.value.toLowerCase();
                const bookList = document.getElementById('bookList');
                const items = bookList.getElementsByTagName('li');
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    const title = item.firstChild.textContent.toLowerCase();
                    if (title.includes(searchQuery)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                }
            });
        }
    </script>
</head>
<body>
    <header>
        <h1>Nossa Biblioteca</h1>
        <p>"a leitura é a chave do conhecimento"</p>
        <div id="doe">
            <h5>Doe Bitcoin</h5>
            <p>thiagooliveirash@strike.me</p>
        </div>
        <div id="bookCount">0 livros</div> <!-- Contador de livros -->
    </header>
    <main>
        <section id="upload-section">
            <h2>Adicionar Livros</h2>
            <input type="file" id="fileInput" accept=".pdf" multiple required>
            <input type="text" id="categoryInput" placeholder="Categoria do livro" required>
            <button id="uploadButton">Adicionar Livros</button>
            <!-- Barra de progresso e feedback de status -->
            <div id="progressContainer" style="display: none;">
                <progress id="progressBar" value="0" max="100" style="width: 100%;"></progress>
            </div>
     <p id="statusMessage"></p>
        </section>

        <section id="search-section">
            <h2>Buscar Livros</h2>
            <input type="text" id="search" placeholder="Pesquisar por título">
            <select id="categoryFilter">
                <option value="">Todas as categorias</option>
            </select>
        </section>

        <section id="book-list-section">
            <h2>Lista de Livros</h2>
            <ul id="bookList"></ul>
        </section>

        <footer>
            <h2>Contato</h2>
            <p>Entre em contato pelo WhatsApp: 
                <a href="https://wa.me/5511999999999" target="_blank">Clique aqui</a>
            </p>
        </footer>
    </main>
</body>
</html>
