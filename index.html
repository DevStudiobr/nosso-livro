<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nossa Biblioteca</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module">
        // Configuração do Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
        import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDHkscCAj8pSyeN5KPXUn072_5XeSFF04M",
            authDomain: "fire-news-f1be1.firebaseapp.com",
            databaseURL: "https://fire-news-f1be1-default-rtdb.firebaseio.com",
            projectId: "fire-news-f1be1",
            storageBucket: "fire-news-f1be1.appspot.com",
            messagingSenderId: "368411474818",
            appId: "1:368411474818:web:567947238fa8f2da5fad9b",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const uploadButton = document.getElementById('uploadButton');
        const fileInput = document.getElementById('fileInput');
        const searchInput = document.getElementById('search');
        const bookList = document.getElementById('bookList');
        const bookCount = document.getElementById('bookCount');

        // Função para carregar livros
        function loadBooks() {
            const booksRef = ref(db, 'books/');
            onValue(booksRef, (snapshot) => {
                bookList.innerHTML = ''; // Limpa a lista antes de adicionar os novos itens
                let count = 0; // Contador de livros
                const booksArray = [];

                snapshot.forEach((childSnapshot) => {
                    const book = childSnapshot.val();
                    booksArray.push(book); // Adiciona cada livro a um array
                });

                // Ordena os livros pela data de upload (assumindo que você salva um timestamp)
                booksArray.sort((a, b) => b.timestamp - a.timestamp); // Os mais recentes primeiro

                booksArray.forEach((book) => {
                    const li = document.createElement('li');
                    li.textContent = book.title; // Título do livro

                    // Criação do botão de download
                    const downloadButton = document.createElement('button');
                    downloadButton.textContent = 'Baixar';
                    downloadButton.onclick = () => downloadBook(book.fileName); // Define a ação do botão

                    li.appendChild(downloadButton); // Adiciona o botão ao item da lista
                    bookList.appendChild(li);
                    count++;
                });

                bookCount.textContent = `${count} livros`; // Atualiza o contador de livros
            }, (error) => {
                console.error("Erro ao carregar livros:", error); // Log de erro
            });
        }

        // Função para adicionar livros
        uploadButton.addEventListener('click', () => {
            const files = fileInput.files;
            const category = document.getElementById('bookCategory').value;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const title = file.name.replace('.pdf', ''); // Captura o título do arquivo
                const bookData = {
                    title: title,
                    category: category,
                    fileName: file.name,
                    timestamp: Date.now() // Adiciona timestamp
                };
                const newBookRef = ref(db, 'books/' + title);
                set(newBookRef, bookData)
                    .then(() => {
                        console.log("Livro adicionado:", title); // Log de sucesso
                        loadBooks(); // Recarrega a lista após adicionar um livro
                    })
                    .catch((error) => {
                        console.error("Erro ao adicionar livro:", error); // Log de erro
                    });
            }
            fileInput.value = ''; // Limpa o input após o upload
            document.getElementById('bookCategory').value = ''; // Limpa a categoria
        });

        // Função para baixar livro
        function downloadBook(fileName) {
            const storageUrl = `https://firebasestorage.googleapis.com/v0/b/${firebaseConfig.storageBucket}/o/${encodeURIComponent(fileName)}?alt=media`;
            const link = document.createElement('a');
            link.href = storageUrl;
            link.download = fileName; // Define o nome do arquivo ao baixar
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Função para pesquisar livros
        searchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase();
            const items = bookList.getElementsByTagName('li');

            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.textContent.toLowerCase().includes(searchTerm)) {
                    item.style.display = ''; // Exibe o item
                } else {
                    item.style.display = 'none'; // Oculta o item
                }
            }
        });

        // Carrega livros ao inicializar
        loadBooks();
    </script>
</head>
<body>
    <header>
        <h1>Nossa Biblioteca</h1>
        <p>Compartilhe e baixe livros gratuitamente!</p>
        <div id="bookCount">0 livros</div> <!-- Contador de livros -->
    </header>

    <main>
        <section id="upload-section">
            <h2>Adicionar Livro</h2>
            <input type="text" id="bookCategory" placeholder="Categoria do Livro" required>
            <input type="file" id="fileInput" accept=".pdf" multiple required>
            <button id="uploadButton">Adicionar Livros</button>
        </section>

        <section id="search-section">
            <h2>Pesquisar Livros</h2>
            <input type="text" id="search" placeholder="Pesquise pelo título...">
        </section>

        <section id="books-section">
            <h2>Livros Disponíveis</h2>
            <ul id="bookList"></ul>
        </section>
    </main>
</body>
</html>
